name: Build and Push Container

on:
  workflow_call:
    secrets:
      AWS_ACCOUNT_ID:
        required: true
    inputs:
      wrapper-name:
        description: Wrapper name (e.g., indexer-container)
        required: true
        type: string
      image-tag:
        description: Image tag to push (latest is always pushed).
        required: false
        type: string
        default: latest
      aws-region:
        description: AWS region for ECR.
        required: false
        type: string
        default: us-east-1
      node-version:
        required: false
        type: string
        default: '22'
      bun-version:
        required: false
        type: string
        default: '1.2.13'

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Setup Workspace
        uses: ./.github/actions/setup-workspace
        with:
          node-version: ${{ inputs.node-version }}
          bun-version: ${{ inputs.bun-version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: ${{ inputs.aws-region }}

      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "${{ inputs.aws-region }}" \
            | docker login --username AWS --password-stdin "${{ steps.account.outputs.id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com"

      - name: Build and Push
        run: |
          IMAGE="${{ steps.account.outputs.id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com/weft-${{ inputs.wrapper-name }}"
          docker buildx build \
            --platform linux/arm64 \
            --pull \
            -t "${IMAGE}:${{ inputs.image-tag }}" \
            -t "${IMAGE}:latest" \
            -f "aws-wrappers/${{ inputs.wrapper-name }}/Dockerfile" \
            --push .
